{% extends 'portfolio/base.html' %}
{% load static %}
{% load category_colors %}

{% block content %}
<div class="bg-navy-900 min-h-screen py-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Back Link -->
        <a href="{% url 'portfolio_list' %}"
            class="inline-flex items-center text-gray-400 hover:text-white mb-8 transition-colors group">
            <svg class="w-5 h-5 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Portfolio
        </a>

        <!-- Main Content Card -->
        <article class="bg-navy-800 rounded-2xl overflow-hidden border border-white/5 shadow-2xl">

            <!-- Header / Cover -->
            <div class="relative h-64 md:h-96 w-full bg-navy-700">
                {% if item.cover_image %}
                <img src="{{ item.cover_image.url }}" alt="{{ item.title }}"
                    class="w-full h-full object-cover opacity-60">
                {% else %}
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-navy-800 to-navy-900">
                    <svg class="w-24 h-24 text-gray-600 opacity-50" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                        </path>
                    </svg>
                </div>
                {% endif %}
                <div class="absolute inset-0 bg-gradient-to-t from-navy-900 via-transparent to-transparent"></div>

                <div class="absolute bottom-0 left-0 right-0 p-8">
                    <span
                        class="inline-block px-3 py-1 mb-4 text-xs font-bold tracking-wider {{ item.category|category_color }} uppercase backdrop-blur-md rounded-full border {{ item.category|category_bg }}">
                        {{ item.get_category_display }}
                    </span>
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">{{ item.title }}</h1>
                    <p class="text-gray-400">{{ item.created_at|date:"F d, Y" }}</p>
                </div>
            </div>

            <!-- Audio Player Section -->
            <div class="p-8 border-b border-white/5 bg-navy-800/50">
                {% if item.audio_file %}
                <div class="bg-navy-900 rounded-xl p-6 border border-white/5 shadow-inner">
                    <h3 class="text-sm font-semibold text-gray-400 mb-4 uppercase tracking-widest">Now Playing</h3>

                    <audio id="audio-player" class="w-full hidden" controls>
                        <source src="{{ item.audio_file.url }}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>

                    <!-- Custom Player UI -->
                    <div class="flex items-center gap-6">
                        <button id="play-btn"
                            class="w-14 h-14 flex-shrink-0 bg-neon-pink rounded-full flex items-center justify-center text-white shadow-lg hover:scale-105 hover:bg-pink-500 transition-all">
                            <svg id="play-icon" class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                            <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6zm8 0h4v16h-4z" />
                            </svg>
                        </button>

                        <div class="flex-grow flex flex-col justify-center">
                            <!-- Progress Bar -->
                            <div id="progress-container" class="w-full h-2 bg-gray-700 rounded-full relative overflow-hidden cursor-pointer hover:h-3 transition-all">
                                <div id="progress-bar"
                                    class="absolute top-0 left-0 h-full bg-neon-pink w-0 transition-all duration-100">
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-2 font-mono">
                                <span id="current-time">0:00</span>
                                <span id="duration">0:00</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="p-4 bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg text-sm">
                    Audio file not available.
                </div>
                {% endif %}
            </div>

            <!-- Content / Script -->
            <div class="p-8 md:p-12">

                <div class="prose prose-invert prose-lg max-w-none text-gray-300">
                    {{ item.description|safe }}
                </div>
            </div>

        </article>
    </div>
</div>

<script>
    const audio = document.getElementById('audio-player');
    const playBtn = document.getElementById('play-btn');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');
    const currentTimeEl = document.getElementById('current-time');
    const durationEl = document.getElementById('duration');

    if (audio) {
        // Toggle Play/Pause
        playBtn.addEventListener('click', () => {
            if (audio.paused) {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
        });

        // Update Progress
        audio.addEventListener('timeupdate', () => {
            const percent = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = `${percent}%`;
            currentTimeEl.textContent = formatTime(audio.currentTime);
        });

        // Set Duration
        audio.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(audio.duration);
        });

        // Reset on End
        audio.addEventListener('ended', () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            progressBar.style.width = '0%';
        });

        // Seek on Progress Bar Click
        progressContainer.addEventListener('click', (e) => {
            const rect = progressContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const percent = clickX / width;
            const newTime = percent * audio.duration;

            audio.currentTime = newTime;
        });

        // Show preview on hover (optional enhancement)
        progressContainer.addEventListener('mousemove', (e) => {
            const rect = progressContainer.getBoundingClientRect();
            const hoverX = e.clientX - rect.left;
            const width = rect.width;
            const percent = hoverX / width;
            const hoverTime = percent * audio.duration;

            // You can add a tooltip here showing the time
            progressContainer.title = formatTime(hoverTime);
        });

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }
    }
</script>
{% endblock %}